---
title: ä¸­é—´ä»¶ç³»ç»Ÿä½¿ç”¨è¯´æ˜
date: 2025-09-19
categories:
  - æŠ€æœ¯æ–‡æ¡£
tags:
  - ä¸­é—´ä»¶
  - æœåŠ¡å™¨
  - å®‰å…¨
---

# Lumos ä¸­é—´ä»¶ç³»ç»Ÿä½¿ç”¨è¯´æ˜

Lumos ç°åœ¨æ”¯æŒå…¨å±€ä¸­é—´ä»¶åŠŸèƒ½ï¼Œå…è®¸å¼€å‘è€…åœ¨è¯·æ±‚å¤„ç†æµç¨‹ä¸­æ·»åŠ è‡ªå®šä¹‰é€»è¾‘ï¼Œå¦‚IPè®¿é—®æ§åˆ¶ã€æ—¥å¿—è®°å½•ã€è¯·æ±‚å¤´ä¿®æ”¹ç­‰ã€‚

ä¸­é—´ä»¶ç›¸å…³ä»£ç å·²ç§»è‡³ [/src/middlewares](file:///Users/yjj/WebstormProjects/lumos/src/middlewares) ç›®å½•ä¸‹ï¼Œä¾¿äºç®¡ç†å’Œæ‰©å±•ã€‚

## ä¸­é—´ä»¶ç‰¹æ€§

1. **ä¼˜å…ˆçº§æ§åˆ¶**ï¼šå¯ä»¥ä¸ºä¸­é—´ä»¶è®¾ç½®ä¼˜å…ˆçº§ï¼Œæ•°å€¼è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜
2. **é“¾å¼è°ƒç”¨**ï¼šä¸­é—´ä»¶æŒ‰é¡ºåºæ‰§è¡Œï¼Œå¯é€šè¿‡ `next()` æ–¹æ³•è°ƒç”¨ä¸‹ä¸€ä¸ªä¸­é—´ä»¶
3. **IPè®¿é—®æ§åˆ¶**ï¼šå†…ç½®IPç™½åå•å’Œé»‘åå•åŠŸèƒ½
4. **æ’ä»¶é›†æˆ**ï¼šæ’ä»¶å¯ä»¥é€šè¿‡ `onServerStart` é’©å­æ·»åŠ è‡ªå®šä¹‰ä¸­é—´ä»¶

## é…ç½®IPè®¿é—®æ§åˆ¶

åœ¨ `lumos.config.json` ä¸­é…ç½®IPè®¿é—®æ§åˆ¶ï¼š

```json
{
  "middleware": {
    "ipWhitelist": ["127.0.0.1", "192.168.1.10"],
    "ipBlacklist": ["192.168.1.100", "10.0.0.5"]
  }
}
```

> æ³¨æ„ï¼šå¦‚æœé…ç½®äº†ç™½åå•ï¼Œåªæœ‰ç™½åå•ä¸­çš„IPå¯ä»¥è®¿é—®ï¼›å¦‚æœåªé…ç½®äº†é»‘åå•ï¼Œé™¤äº†é»‘åå•ä¸­çš„IPéƒ½å¯ä»¥è®¿é—®ã€‚

## åˆ›å»ºè‡ªå®šä¹‰ä¸­é—´ä»¶æ’ä»¶

å¯ä»¥é€šè¿‡åˆ›å»ºæ’ä»¶æ¥æ·»åŠ è‡ªå®šä¹‰ä¸­é—´ä»¶ï¼š

```typescript
import { Plugin } from '../src/types.ts'
import { LumosContext } from '../src/context.ts'

const middlewareExamplePlugin: Plugin = {
  name: 'middleware-example-plugin',
  version: '1.0.0',
  description: 'ç¤ºä¾‹æ’ä»¶ï¼Œæ¼”ç¤ºå¦‚ä½•æ·»åŠ è‡ªå®šä¹‰ä¸­é—´ä»¶',

  async onServerStart(server: any) {
    server.addMiddleware({
      name: 'logging-middleware',
      priority: -50,
      handler: async (ctx: LumosContext, next: () => Promise<Response>) => {
        const startTime = Date.now()
        const ua = ctx.get('user-agent') || ''
        console.log(`ğŸ“¥ ${ctx.method} ${ctx.path} - UA: ${ua}`)

        const result = await next()

        const status = result?.status ?? ctx.status
        const duration = Date.now() - startTime
        console.log(`ğŸ“¤ å“åº”çŠ¶æ€: ${status} - è€—æ—¶: ${duration}ms`)

        return result
      }
    })
  }
}

export default middlewareExamplePlugin
```

## ä¸­é—´ä»¶æ‰§è¡Œæµç¨‹

```
[å®¢æˆ·ç«¯è¯·æ±‚]
     â†“
[IPè®¿é—®æ§åˆ¶ä¸­é—´ä»¶] (é«˜ä¼˜å…ˆçº§)
     â†“
[æ’ä»¶æ³¨å†Œçš„ä¸­é—´ä»¶] (æŒ‰ä¼˜å…ˆçº§æ’åº)
     â†“
[å®é™…è¯·æ±‚å¤„ç†]
     â†“
[è¿”å›å“åº”]
```

## å†…ç½®ä¸­é—´ä»¶

### IPè®¿é—®æ§åˆ¶ä¸­é—´ä»¶

è‡ªåŠ¨æ³¨å†Œçš„ç¬¬ä¸€ä¸ªä¸­é—´ä»¶ï¼Œç”¨äºæ§åˆ¶IPè®¿é—®æƒé™ã€‚

## æœ€ä½³å®è·µ

1. **åˆç†è®¾ç½®ä¼˜å…ˆçº§**ï¼šå®‰å…¨ç›¸å…³çš„ä¸­é—´ä»¶ï¼ˆå¦‚IPæ§åˆ¶ï¼‰åº”è®¾ç½®è¾ƒé«˜çš„ä¼˜å…ˆçº§ï¼ˆè´Ÿæ•°ï¼‰
2. **å¼‚å¸¸å¤„ç†**ï¼šåœ¨ä¸­é—´ä»¶ä¸­åº”å¦¥å–„å¤„ç†å¼‚å¸¸ï¼Œé¿å…å½±å“æ•´ä¸ªè¯·æ±‚å¤„ç†æµç¨‹
3. **æ€§èƒ½è€ƒè™‘**ï¼šé¿å…åœ¨ä¸­é—´ä»¶ä¸­æ‰§è¡Œè€—æ—¶æ“ä½œï¼Œå½±å“æœåŠ¡å™¨æ€§èƒ½
4. **æ—¥å¿—è®°å½•**ï¼šé€‚å½“æ·»åŠ æ—¥å¿—ï¼Œä¾¿äºè°ƒè¯•å’Œç›‘æ§
