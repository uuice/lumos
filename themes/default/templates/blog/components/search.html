<div
  id="search-bar"
  class="hidden lg:flex transition-all items-center h-11 mr-2 rounded-lg bg-black/[0.04] hover:bg-black/[0.06] focus-within:bg-black/[0.06] dark:bg-white/5 dark:hover:bg-white/10 dark:focus-within:bg-white/10"
>
  <svg
    xmlns="http://www.w3.org/2000/svg"
    aria-hidden="true"
    role="img"
    class="absolute text-[1.25rem] pointer-events-none ml-3 transition my-auto text-black/30 dark:text-white/30 iconify iconify--material-symbols"
    width="1em"
    height="1em"
    viewBox="0 0 24 24"
  >
    <path
      fill="currentColor"
      d="m19.6 21l-6.3-6.3q-.75.6-1.725.95T9.5 16q-2.725 0-4.612-1.888T3 9.5t1.888-4.612T9.5 3t4.613 1.888T16 9.5q0 1.1-.35 2.075T14.7 13.3l6.3 6.3zM9.5 14q1.875 0 3.188-1.312T14 9.5t-1.312-3.187T9.5 5T6.313 6.313T5 9.5t1.313 3.188T9.5 14"
    ></path>
  </svg>
  <input
    id="search-input"
    class="transition-all pl-10 text-sm bg-transparent !outline-none !border-none !shadow-none h-full w-40 active:w-60 focus:w-60 text-black/50 dark:text-white/50"
    placeholder="Search"
    style="outline: none !important; box-shadow: none !important; border: none !important"
  />
</div>
<button
  aria-label="Search Panel"
  id="search-switch"
  class="btn-plain scale-animation lg:!hidden rounded-lg w-11 h-11 active:scale-90"
>
  <svg
    xmlns="http://www.w3.org/2000/svg"
    aria-hidden="true"
    role="img"
    class="text-[1.25rem] iconify iconify--material-symbols"
    width="1em"
    height="1em"
    viewBox="0 0 24 24"
  >
    <path
      fill="currentColor"
      d="m19.6 21l-6.3-6.3q-.75.6-1.725.95T9.5 16q-2.725 0-4.612-1.888T3 9.5t1.888-4.612T9.5 3t4.613 1.888T16 9.5q0 1.1-.35 2.075T14.7 13.3l6.3 6.3zM9.5 14q1.875 0 3.188-1.312T14 9.5t-1.312-3.187T9.5 5T6.313 6.313T5 9.5t1.313 3.188T9.5 14"
    ></path>
  </svg>
</button>

<div
  id="search-panel"
  class="float-panel search-panel absolute md:w-[30rem] top-20 left-4 md:left-[unset] right-4 shadow-2xl rounded-2xl p-2 float-panel-closed"
>
  <div
    id="search-bar-inside"
    class="flex relative lg:hidden transition-all items-center h-11 rounded-xl bg-black/[0.04] hover:bg-black/[0.06] focus-within:bg-black/[0.06] dark:bg-white/5 dark:hover:bg-white/10 dark:focus-within:bg-white/10"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      aria-hidden="true"
      role="img"
      class="absolute text-[1.25rem] pointer-events-none ml-3 transition my-auto text-black/30 dark:text-white/30 iconify iconify--material-symbols"
      width="1em"
      height="1em"
      viewBox="0 0 24 24"
    >
      <path
        fill="currentColor"
        d="m19.6 21l-6.3-6.3q-.75.6-1.725.95T9.5 16q-2.725 0-4.612-1.888T3 9.5t1.888-4.612T9.5 3t4.613 1.888T16 9.5q0 1.1-.35 2.075T14.7 13.3l6.3 6.3zM9.5 14q1.875 0 3.188-1.312T14 9.5t-1.312-3.187T9.5 5T6.313 6.313T5 9.5t1.313 3.188T9.5 14"
      ></path>
    </svg>
    <input
      id="search-input-inside"
      placeholder="Search"
      class="pl-10 absolute inset-0 text-sm bg-transparent !outline-none !border-none !shadow-none focus:w-60 text-black/50 dark:text-white/50"
      style="outline: none !important; box-shadow: none !important; border: none !important"
    />
  </div>
  <div id="search-results" class="mt-2">
    <!-- 搜索结果将在这里动态生成 -->
  </div>
</div>

<script>
  $(function () {
    // 切换搜索面板显示/隐藏
    $('#search-switch').on('click', function () {
      $('#search-panel').toggleClass('float-panel-closed')
    })

    // 添加点击外部区域关闭搜索面板的功能
    $(document).on('click', function (event) {
      // 如果点击的不是搜索面板内的元素，也不是搜索按钮，也不是搜索输入框
      if (
        !$(event.target).closest('#search-panel').length &&
        !$(event.target).closest('#search-switch').length &&
        !$(event.target).closest('#search-bar').length
      ) {
        // 关闭搜索面板
        $('#search-panel').addClass('float-panel-closed')
      }
    })

    // 搜索函数
    function performSearch(query) {
      if (!query || query.trim() === '') {
        $('#search-results').empty()
        return
      }

      // 显示加载状态
      $('#search-results').html(
        '<div class="text-center py-4 text-black/75 dark:text-white/75">搜索中...</div>'
      )

      // 调用搜索API
      $.ajax({
        url: '/api/content/search/articles',
        method: 'GET',
        data: { q: query },
        headers: {
          'x-access-token': 'web_token_123456789',
          'x-app-name': 'WebApp',
          'x-channel': 'web'
        },
        success: function (res) {
          const data = res.data
          // 清空搜索结果容器
          $('#search-results').empty()

          // 检查是否有结果
          if (!data || data.length === 0) {
            $('#search-results').html(
              '<div class="text-center py-4 text-black/75 dark:text-white/75">没有找到相关结果</div>'
            )
            return
          }

          // 遍历结果并添加到搜索结果容器
          $.each(data, function (index, item) {
            const _highlight = item._highlight || {}

            // 创建临时元素来安全地解析HTML内容
            const titleContainer = $('<div></div>')
            titleContainer.html(_highlight.title || item.title || '')

            const abstractContainer = $('<div></div>')
            abstractContainer.html(_highlight.abstract || item.abstract || '')

            // 构建搜索结果项
            var resultItem = $(`
              <a class="transition first-of-type:mt-2 lg:first-of-type:mt-0 group block rounded-xl text-lg px-3 py-2 hover:bg-[var(--btn-plain-bg-hover)] active:bg-[var(--btn-plain-bg-active)]" href="${'/archives/' + item.url}">
                <div class="transition text-90 inline-flex font-bold group-hover:text-[var(--primary)]">
                  <span class="title-content"></span>
                  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" class="transition text-[0.75rem] translate-x-1 my-auto text-[var(--primary)] iconify iconify--fa6-solid" width="0.63em" height="1em" viewBox="0 0 320 512">
                    <path fill="currentColor" d="M310.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-192 192c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L242.7 256L73.4 86.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l192 192z"></path>
                  </svg>
                </div>
                <div class="transition text-sm text-50 abstract-content">
                </div>
              </a>
            `)

            // 将HTML内容安全地添加到结果项中
            resultItem.find('.title-content').html(titleContainer.html())
            resultItem.find('.abstract-content').html(abstractContainer.html())

            // 添加到结果容器
            $('#search-results').append(resultItem)
          })
        },
        error: function (xhr, status, error) {
          console.error('搜索请求失败:', error)
          $('#search-results').html(
            '<div class="text-center py-4 text-black/75 dark:text-white/75">搜索失败，请稍后重试</div>'
          )
        }
      })
    }

    // 防抖函数，避免频繁请求
    function debounce(func, wait) {
      let timeout
      return function () {
        const context = this
        const args = arguments
        clearTimeout(timeout)
        timeout = setTimeout(function () {
          func.apply(context, args)
        }, wait)
      }
    }

    // 为两个搜索输入框添加事件监听
    const debouncedSearch = debounce(performSearch, 300)

    // 大屏幕搜索框
    $('#search-input').on('input', function () {
      const query = $(this).val()
      if (query && query.trim() !== '') {
        // 如果有输入内容，确保搜索面板可见
        $('#search-panel').removeClass('float-panel-closed')
      }
      debouncedSearch(query)
    })

    // 小屏幕搜索框
    $('#search-input-inside').on('input', function () {
      const query = $(this).val()
      debouncedSearch(query)
    })

    // 按下回车键时执行搜索
    $('#search-input, #search-input-inside').on('keypress', function (e) {
      if (e.which === 13) {
        // 回车键的键码是13
        const query = $(this).val()
        performSearch(query)
      }
    })
  })
</script>
